{% extends 'base.html' %}

{% block content %}
<div class="container my-5">
  <div class="row">
    <!-- Doctor Profile Card -->
    <div class="col-md-5">
      <div class="card shadow p-4 text-center">
        <img src="{{ doctor.profile_image.url }}" class="img-fluid rounded-circle mb-3"
             style="width: 150px; height: 150px; object-fit: cover;"
             alt="{{ doctor.user.username }}">
        <h3 class="mb-2">Dr. {{ doctor.user.first_name }}</h3>
        <p class="text-muted">{{ doctor.major }}</p>
        <p>{{ doctor.major_description }}</p>
        <hr>
        <p><strong>Consultation Fee:</strong> <span class="text-success">${{ doctor.consultation_fee }}</span></p>
        <p><strong>Work Time:</strong> {{ doctor.work_start_time }} ‚Äì {{ doctor.work_end_time }}</p>
        <p><strong>Phone:</strong> {{ doctor.phone_number }}</p>
        <p><strong>Office:</strong> {{ doctor.location_medical_office }}</p>
        <p class="fst-italic">{{ doctor.bio }}</p>
      </div>
    </div>

    <!-- Right Column -->
    <div class="col-md-7">
      <div class="card shadow p-4 mb-4">
        <h4 class="mb-4">üìÖ Book an Appointment</h4>

        {% if success %}
        <div class="alert alert-success">{{ success }}</div>
        {% endif %}

        <form method="post">
          {% csrf_token %}
          <div class="mb-3">
            {{ form.name.label_tag }}
            {{ form.name }}
            {% if form.name.errors %}
              <div class="text-danger small">{{ form.name.errors }}</div>
            {% endif %}
          </div>
          <div class="mb-3">
            {{ form.phone_number.label_tag }}
            {{ form.phone_number }}
            {% if form.phone_number.errors %}
              <div class="text-danger small">{{ form.phone_number.errors }}</div>
            {% endif %}
          </div>
          <button type="submit" class="btn btn-success w-100">
            <i class="bi bi-calendar-check"></i> Book Appointment
          </button>
        </form>

        {% if request.user.is_authenticated and request.user.role == 'patient' and request.user.id != doctor.user.id %}
        <a href="{% url 'chat:start' other_user_id=doctor.user.id %}" class="btn btn-primary w-100 mt-3">
          <i class="bi bi-chat-dots"></i> Message Doctor
        </a>
        {% endif %}
      </div>

      <!-- Rating Section -->
      <div class="card shadow p-4">
        {% include 'partial/alert.html' %}
        <h4 class="mb-3">‚≠ê Rate this Doctor</h4>
        <form method="post" action="{% url 'profile:rate' doctor_id=doctor.id %}">
          {% csrf_token %}
          <div class="d-flex align-items-center mb-3">
            <label for="rating" class="me-2 fw-bold">Your Rating:</label>
            <select name="rating" class="form-select w-auto" required>
              <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
              <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
              <option value="3">‚≠ê‚≠ê‚≠ê</option>
              <option value="2">‚≠ê‚≠ê</option>
              <option value="1">‚≠ê</option>
            </select>
          </div>

          <textarea name="comment" class="form-control mb-3"
                    rows="3" placeholder="Leave a comment (optional)"></textarea>

          <button type="submit" class="btn btn-warning w-100">
            <i class="bi bi-star"></i> Submit Rating
          </button>
        </form>

        <hr>
        <h5 class="mt-3">Average Rating: <span class="text-warning">{{ doctor.average_rating }} ‚≠ê</span></h5>

        <ul class="list-group mt-3">
          {% for r in doctor.ratings.all %}
          <li class="list-group-item">
            <strong>{{ r.patient.first_name }}</strong>  
            <span class="text-warning">{{ r.rating }} ‚≠ê</span>  
            <br>
            <small class="text-muted">{{ r.comment }}</small>
          </li>
          {% empty %}
          <li class="list-group-item text-muted">No ratings yet</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}
